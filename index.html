<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>The Cat in the Hat Comes Back!</title>
    <script src="https://fb.me/react-15.0.0.js"></script>
    <script src="https://fb.me/react-dom-15.0.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.0.4/redux.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
  </head>

  <body>
    <div id="app"></div>

<script type="text/babel">


const toggleSquare = (text) => {
  switch (text) {
    case '_': return 'x';
    case 'x': return 'o';
    case 'o': return '_';
    default: return '_';
  }
}

const boardReducer = (state = [
    {id: 1, text: '_' }, {id: 2, text: '_' }, {id: 3, text: '_' },
    {id: 4, text: '_' }, {id: 5, text: '_' }, {id: 6, text: '_' },
    {id: 7, text: '_' }, {id: 8, text: '_' }, {id: 9, text: '_' }
  ], action) => {
  switch (action.type) {
    case 'SQUARE_CLICKED':
      console.log('square' + action.id + 'clicked!')
      let newState = state.map((i) => {
        console.log('mapping item:')
        console.log(i)
        return i.id === action.id ? Object.assign({}, i, { text: toggleSquare(action.text), id: action.id }) : i
      });

      console.log("new boardState: "); console.log(newState);
      return newState;

    default:
      return state;
  }
}


const { createStore } = Redux
const store = createStore(boardReducer)

/*******************************************************************************
*                                   REACT                                      *
*******************************************************************************/

class App extends React.Component {

  constructor(props) {
    super(props)
    this.state = {
      tic: (id, text) => { return () => {
        props.dispatch({ type: 'SQUARE_CLICKED', id: id, text: text })
      }},
      boardState: props.boardState
    }

  }

  componentWillReceiveProps(nextProps) {
    this.setState({
      boardState: nextProps.boardState
    })
  }

  render() {
    return (
      <span>
        <Board tic={this.state.tic} boardState={this.state.boardState} />
      </span>
    )
  }
}

class Board extends React.Component {

  constructor(props) {
    super(props)
    this.state = {
      tic: props.tic,
      boardState: props.boardState
    }
  }

  componentWillReceiveProps(nextProps) {
    this.setState({
      boardState: nextProps.boardState
    })
  }

  render() {
    return (
      <table onclick={this.state.tic}>
        <tbody>
          <tr>
            <td><Square tic={this.state.tic} square={this.state.boardState[0]} /></td><td><Square tic={this.state.tic} square={this.state.boardState[1]} /></td><td><Square tic={this.state.tic} square={this.state.boardState[2]} /></td>
          </tr>
          <tr>
            <td><Square tic={this.state.tic} square={this.state.boardState[3]}  /></td><td><Square tic={this.state.tic} square={this.state.boardState[4]}  /></td><td><Square tic={this.state.tic} square={this.state.boardState[5]}  /></td>
          </tr>
          <tr>
            <td><Square tic={this.state.tic} square={this.state.boardState[6]}  /></td><td><Square tic={this.state.tic} square={this.state.boardState[7]} /></td><td><Square tic={this.state.tic} square={this.state.boardState[8]}  /></td>
          </tr>
        </tbody>
      </table>
    )
  }
}

class Square extends React.Component {

  constructor(props) {
    super(props);
    console.log('creating square with:'); console.log(props);
    this.state = {
      click: props.tic(props.square.id, props.square.text),
      text: props.square.text,
      id: props.square.id
    }
  }

  componentWillReceiveProps(nextProps) {

    console.log("will receive Props"); console.log(nextProps);

    this.setState({
      click: nextProps.tic(nextProps.square.id, nextProps.square.text),
      text: nextProps.square.text,
      id: nextProps.square.id
    })
  }

  render() {

    const squareStyle = {
      fontSize: '128px'
    }

    return (
      <span style={squareStyle} onClick={this.state.click}>{this.state.text}</span>
    )
  }
}

store.subscribe(() => {
  console.log("updating react DOM with:"); console.log(store.getState());
  ReactDOM.render(<App boardState={store.getState()} dispatch={store.dispatch} />, document.getElementById('app'));
})

ReactDOM.render(<App boardState={store.getState()} dispatch={store.dispatch} />, document.getElementById('app'));


</script>

  </body>
</html>
